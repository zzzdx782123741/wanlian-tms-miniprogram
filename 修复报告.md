# 万联驿站TMS 小程序调试与修复报告

**生成时间**：2026-02-08
**当前版本标签**：`backup-before-adjustments-20260208` (GitHub)

## 1. 概述
本报告记录了对“万联驿站TMS”微信小程序端的系统性调试与修复工作。主要解决了导致编译失败的 WXML 语法错误、路由配置缺失导致的跳转异常，以及 API 环境配置硬编码问题。

## 2. 修复内容详情

### 2.1 WXML 编译错误修复 (Critical)
**问题描述**：小程序 WXML 模板中使用了不支持的 JavaScript 语法（箭头函数 `=>` 和可选链 `?.`），导致编译器报错，无法预览。
**修复文件**：
- `pages/fleets/fleets.wxml` & `.js`: 移除了 picker 中的 `findIndex` 箭头函数，改为在 JS 中计算 `statusIndex`。
- `pages/stores/stores.wxml` & `.js`: 同上，修复了 statusOptions 的索引获取方式。
- `pages/users/users.wxml`: 移除了 `item.role?.status` 等可选链写法，改为 `item.role && item.role.status`。
- `pages/auth/register.wxml` & `.js`: 修复了角色选择器的箭头函数绑定问题。
- `pages/store/quote/quote.wxml` & `.js`: 移除了在 WXML 中直接调用 `calculateTotal().toFixed(2)`，改为使用 `wxs` 模块处理格式化，并增加 `totalAmount` 数据字段。

### 2.2 路由配置与导航修复 (Major)
**问题描述**：`app.json` 中缺失了大量业务页面（如司机端、车队端页面），导致虽然文件存在但无法跳转（报错 `route "..." is not defined`）。同时部分页面尝试跳转到不存在的 `detail` 页面。
**修复内容**：
- **补全 `app.json`**：依据 `TESTING.md` 的业务流程，将所有业务页面路径添加到 `pages` 数组中。
- **清理无效跳转**：
  - 修复了 `fleets`, `stores`, `vehicle` 等列表页跳转到不存在的 `/detail` 页面的问题。
  - 将无效跳转统一指向现有的详情页，或修正为正确的跳转路径（如跳转到 `edit` 或 `report` 页面）。

### 2.3 环境配置优化 (Optimization)
**问题描述**：`request.js` 中 API 地址硬编码为 `localhost:3000`，导致真机调试困难。
**修复内容**：
- 改造 `app.js` 和 `utils/request.js`。
- 引入优先级配置：优先读取 `wx.getStorageSync('baseUrl')` -> 其次读取 `globalData.baseUrl` -> 默认回落 `localhost`。
- 方便开发者在不修改代码的情况下，通过 Storage 切换测试环境地址（如局域网 IP）。

## 3. 版本与备份
- **Git 仓库**：已在 `projects/wanlian-tms-miniprogram` 初始化 Git。
- **远程备份**：已推送到 GitHub 远程仓库。
- **基线标签**：打标 `backup-before-adjustments-20260208`，包含修复前的快照（注意：本次修复是在该备份之后进行的，建议确认无误后再次提交）。

## 4. 后续建议
1. **API 联调**：请确保后端服务（wanlian-tms-api）已启动，且 MongoDB 连接正常。
2. **真机预览**：如需真机预览，请在“详情”中勾选“不校验合法域名”，或将电脑 IP 配置为 baseUrl。
3. **自动化测试**：建议后续补充核心业务链路（报修->接单->报价）的自动化测试脚本。
