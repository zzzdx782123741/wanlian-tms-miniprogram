<!--pages/maintenance/maintenance.wxml - ä¿å…»ç”³è¯·é¡µé¢-->
<view class="page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="header">
    <view class="header-title">ä¿å…»ç”³è¯·</view>
    <view class="header-subtitle">é€‰æ‹©ä¿å…»ç±»å‹å’Œå¥—é¤</view>
  </view>

  <scroll-view class="content" scroll-y>
    <!-- è½¦è¾†ä¿¡æ¯ -->
    <view class="card">
      <view class="card-title">è½¦è¾†ä¿¡æ¯</view>
      <view class="vehicle-info">
        <text class="plate-number">{{vehicle.plateNumber}}</text>
        <text class="vehicle-model">{{vehicle.brand}} {{vehicle.model}}</text>
        <view class="mileage">å½“å‰é‡Œç¨‹ï¼š{{vehicle.mileage}} km</view>
      </view>
    </view>

    <!-- æœåŠ¡åœ°å€ -->
    <view class="card">
      <view class="card-title">æœåŠ¡åœ°å€</view>
      <view class="location-info">
        <text class="location-icon">ğŸ“</text>
        <view class="location-content">
          <view class="location-address">{{serviceLocation.address}}</view>
          <view class="location-tip">ç‚¹å‡»ä¿®æ”¹æœåŠ¡åœ°å€</view>
        </view>
        <button class="location-change-btn" catchtap="onChangeLocation">
          <text class="location-change-icon">ğŸ“</text>
          <text>ä¿®æ”¹åœ°å€</text>
        </button>
      </view>
    </view>

    <!-- ä¿å…»ç±»å‹ -->
    <view class="card" wx:if="{{maintenanceTypes.length > 0}}">
      <view class="card-title">é€‰æ‹©ä¿å…»ç±»å‹</view>
      <scroll-view class="type-list" scroll-x>
        <view
          class="type-item {{selectedTypeIndex === index ? 'active' : ''}}"
          wx:for="{{maintenanceTypes}}"
          wx:key="*this"
          data-index="{{index}}"
          bindtap="onSelectType"
        >
          <text class="type-icon">{{item.icon}}</text>
          <text class="type-name">{{item.name}}</text>
          <text class="type-desc">{{item.description}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- æ¨èå¥—é¤ -->
    <view class="card" wx:if="{{recommendedPackages.length > 0}}">
      <view class="card-title">
        <text>æ¨èå¥—é¤</text>
        <text class="title-tip" wx:if="{{fleetConfig.maintenanceProductPermission === 'driver_select'}}">ï¼ˆå«å•†å“æ˜ç»†å’Œä»·æ ¼ï¼‰</text>
      </view>

      <view class="packages-list">
        <view
          class="package-item {{selectedPackageIndex === index ? 'active' : ''}}"
          wx:for="{{recommendedPackages}}"
          wx:key="*this"
          data-index="{{index}}"
          bindtap="onSelectPackage"
        >
          <view class="package-header">
            <text class="package-name">{{item.name}}</text>
            <view class="package-tier">
              <text class="tier-tag" data-tier="{{item.tier}}">{{item.tierName}}</text>
              <text class="package-price">Â¥{{item.price}}</text>
            </view>
            <view class="package-products">å« {{item.products.length }} é¡¹å•†å“</view>
          </view>
          <view class="package-desc" wx:if="{{item.description}}">
            <text>{{item.description}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ¡£ä½é€‰æ‹©ï¼ˆå¸æœºæ— å•†å“æƒé™æ—¶ï¼‰ -->
    <view class="card" wx:if="{{fleetConfig.maintenanceProductPermission !== 'driver_select' && recommendedPackages.length > 0}}">
      <view class="card-title">é€‰æ‹©æ¡£ä½</view>
      <view class="tier-list">
        <view
          class="tier-item {{selectedTier === index ? 'active' : ''}}"
          wx:for="{{tiers}}"
          wx:key="*this"
          data-index="{{index}}"
          bindtap="onSelectTier"
        >
          <text class="tier-name">{{item.name}}</text>
          <text class="tier-desc">{{item.priceRange}}</text>
        </view>
      </view>
    </view>

    <!-- è‡ªå®šä¹‰å•†å“ï¼ˆå¸æœºæœ‰æƒé™æ—¶ï¼‰ -->
    <view class="card" wx:if="{{fleetConfig.maintenanceProductPermission === 'driver_select' && allProducts.length > 0}}">
      <view class="card-title">
        <text>é€‰æ‹©å•†å“ï¼ˆå¯å¤šé€‰ï¼‰</text>
        <view class="products-tip">å·²é€‰ {{selectedProductIndices.length}} é¡¹ï¼Œæ€»ä»· Â¥{{calculateProductsPrice()}}</view>
      </view>

      <checkbox-group>
        <label
          class="product-item {{selectedProductIndices.indexOf(index) > -1 ? 'checked' : ''}}"
          wx:for="{{allProducts}}"
          wx:key="*this"
          data-index="{{index}}"
          bindtap="onToggleProduct"
        >
          <view class="product-checkbox">
            <checkbox value="{{index}}" checked="{{selectedProductIndices.indexOf(index) > -1}}" />
          </view>
          <view class="product-info">
            <text class="product-name">{{item.name}}</text>
            <text class="product-spec">{{item.spec}}</text>
            <text class="product-price">Â¥{{item.price}}</text>
          </view>
        </label>
      </checkbox-group>
    </view>

    <!-- åˆ°åº—æ—¶é—´åå¥½ -->
    <view class="card">
      <view class="card-title">åˆ°åº—æ—¶é—´åå¥½</view>
      <view class="time-preference">
        <text class="time-label">æœŸæœ›åˆ°åº—æ—¶é—´ï¼š</text>
        <view class="time-value" wx:if="{{preferredDate && preferredTime}}">
          <text>{{preferredDate}} {{preferredTime}}</text>
          <text class="time-change" bindtap="openTimePicker">ä¿®æ”¹</text>
        </view>
        <view class="time-value" wx:else>
          <text>ä¸é™</text>
          <text class="time-change" bindtap="openTimePicker">è®¾ç½®</text>
        </view>
      </view>
    </view>

    <!-- å¸æœºå¤‡æ³¨ -->
    <view class="card">
      <view class="card-title">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</view>
      <textarea
        class="remark-input"
        placeholder="å¦‚æœ‰å…¶ä»–éœ€æ±‚è¯·è¯´æ˜"
        value="{{driverRemark}}"
        bindinput="onRemarkInput"
        maxlength="500"
        show-length
      />
    </view>

    <!-- é—¨åº—å®‰æ’æç¤ºï¼ˆç®¡ç†å‘˜é€‰é—¨åº—æ—¶ï¼‰-->
    <view class="card" wx:if="{{!fleetConfig.allowDriverSelectStore}}">
      <view class="fleet-tip-card">
        <view class="tip-icon">ğŸ’¡</view>
        <view class="tip-content">
          <view class="tip-title">è”ç³»é—¨åº—ç¡®è®¤æ—¶é—´</view>
          <view class="tip-text">æäº¤åè½¦é˜Ÿç®¡ç†å‘˜å°†ä¸ºæ‚¨å®‰æ’é—¨åº—ï¼Œè¯·ç•™æ„è®¢å•çŠ¶æ€å¹¶åŠæ—¶è”ç³»é—¨åº—ç¡®è®¤åˆ°åº—æ—¶é—´</view>
        </view>
      </view>
    </view>
    <!-- æäº¤æŒ‰é’® -->
    <view class="submit-container">
      <button
        class="submit-btn"
        bindtap="onSubmit"
        disabled="{{submitting}}"
      >
        {{submitting ? 'æäº¤ä¸­...' : 'æäº¤ä¿å…»ç”³è¯·'}}
      </button>
    </view>

    <!-- æ—¶é—´é€‰æ‹©å™¨ -->
    <view class="picker-mask" wx:if="{{showTimePicker}}" bindtap="closeTimePicker">
      <view class="picker-popup" catchtap="">
        <view class="picker-header">
          <text class="picker-title">é€‰æ‹©åˆ°åº—æ—¶é—´</text>
          <text class="picker-close" bindtap="closeTimePicker">âœ•</text>
        </view>

        <!-- ä¸é™é€‰é¡¹ -->
        <view class="time-unlimited-option" bindtap="selectTimeUnlimited">
          <text class="option-icon">â°</text>
          <text class="option-title">ä¸é™åˆ°åº—æ—¶é—´</text>
          <text class="option-desc">æäº¤åç”±é—¨åº—è”ç³»æ‚¨ç¡®è®¤æ—¶é—´</text>
        </view>

        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="date-section">
          <picker
            mode="date"
            value="{{preferredDate}}"
            start="{{today}}"
            bindchange="onDateChange"
          >
            <view class="date-picker">
              <text class="date-picker-text">{{preferredDate || 'é€‰æ‹©æ—¥æœŸ'}}</text>
            </view>
          </picker>

          <!-- æ—¶é—´é€‰æ‹© -->
          <view class="time-section">
            <scroll-view class="time-slots" scroll-y>
              <view
                class="time-slot-item"
                wx:for="{{timeSlots}}"
                wx:key="*this"
                data-time="{{item}}"
                bindtap="selectTimeSlot"
              >
                {{item}}
              </view>
            </scroll-view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¿®æ”¹åœ°å€é€‰æ‹©å™¨ -->
    <view class="picker-mask" wx:if="{{showLocationPicker}}" bindtap="closeLocationPicker">
      <view class="location-picker-popup" catchtap="">
        <view class="picker-header">
          <text class="picker-title">ä¿®æ”¹æœåŠ¡åœ°å€</text>
          <text class="picker-close" bindtap="closeLocationPicker">âœ•</text>
        </view>

        <button class="location-option" bindtap="onChooseCurrentLocation">
          <text class="option-icon">ğŸ“</text>
          <text class="option-title">å½“å‰ä½ç½®</text>
          <text class="option-desc">{{serviceLocation.address}}</text>
        </button>

        <button class="location-option" bindtap="onChooseFromContacts">
          <text class="option-icon">â­</text>
          <text class="option-title">å¸¸ç”¨åœ°å€</text>
          <text class="option-desc">ä»åœ°å€ç°¿é€‰æ‹©</text>
        </button>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{vehicleLoading || packagesLoading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{vehicleLoading ? 'åŠ è½½è½¦è¾†ä¿¡æ¯...' : 'åŠ è½½æ¨èå¥—é¤...'}}</text>
    </view>
  </scroll-view>
</view>
