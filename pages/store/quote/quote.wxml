<!--pages/store/quote/quote.wxml - é—¨åº—æŠ€å¸ˆå¡«å†™æŠ¥ä»·-->
<wxs module="utils">
  module.exports = {
    toFixed: function(value) {
      return (value || 0).toFixed(2);
    }
  }
</wxs>
<view class="quote-container">
  <block wx:if="{{order}}">
    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ“‹</text>
        <text>è®¢å•ä¿¡æ¯</text>
      </view>

      <view class="info-row">
        <text class="label">è®¢å•å·</text>
        <text class="value">{{order.orderNumber}}</text>
      </view>

      <view class="info-row">
        <text class="label">è½¦ç‰Œå·</text>
        <text class="value">{{(order.vehicleId && order.vehicleId.plateNumber) || '-'}}</text>
      </view>

      <view class="info-row">
        <text class="label">è½¦å‹</text>
        <text class="value">{{(order.vehicleId && order.vehicleId.brand) || '-'}} {{(order.vehicleId && order.vehicleId.model) || ''}}</text>
      </view>

      <view class="info-row">
        <text class="label">é¢„çº¦æ—¶é—´</text>
        <text class="value">{{order.appointmentAtText || 'æœªé¢„çº¦'}}</text>
      </view>

      <view class="info-row-block">
        <text class="label-block">æ•…éšœæè¿°</text>
        <text class="value-block fault-desc">{{order.faultDescription}}</text>
      </view>

      <!-- æ•…éšœå›¾ç‰‡ -->
      <block wx:if="{{order.faultImages && order.faultImages.length > 0}}">
        <view class="fault-images">
          <image
            wx:for="{{order.faultImages}}"
            wx:key="*this"
            wx:for-index="imgIndex"
            class="fault-image"
            src="{{item}}"
            mode="aspectFill"
            bindtap="previewImage"
            data-url="{{item}}"
            data-urls="{{order.faultImages}}"
          />
        </view>
      </block>

      <!-- æ•…éšœè§†é¢‘ -->
      <block wx:if="{{order.faultVideos && order.faultVideos.length > 0}}">
        <view class="fault-videos">
          <view class="section-subtitle">æ•…éšœè§†é¢‘</view>
          <view class="video-list">
            <video
              wx:for="{{order.faultVideos}}"
              wx:key="*this"
              wx:for-index="videoIndex"
              class="fault-video"
              src="{{item}}"
              show-center-play-btn="{{true}}"
              controls="{{true}}"
            />
          </view>
        </view>
      </block>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="info-row-block" wx:if="{{order.remark}}">
        <text class="label-block">å¤‡æ³¨ä¿¡æ¯</text>
        <text class="value-block">{{order.remark}}</text>
      </view>
    </view>

    <!-- æ¥è½¦æ£€æŸ¥ -->
    <view class="form-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ”</text>
        <text>æ¥è½¦æ£€æŸ¥</text>
      </view>

      <!-- å½“å‰é‡Œç¨‹ï¼ˆåªè¯»ï¼‰ -->
      <view class="info-row">
        <text class="label">å½“å‰é‡Œç¨‹</text>
        <text class="value">{{order.milestone || 'æœªå¡«å†™'}} å…¬é‡Œ</text>
      </view>

      <!-- æ•…éšœè¯Šæ–­ -->
      <view class="form-item">
        <text class="label">æ•…éšœè¯Šæ–­</text>
        <textarea
          class="textarea-field"
          placeholder="è¯·è¾“å…¥æ•…éšœè¯Šæ–­ç»“æœï¼ˆé€‰å¡«ï¼‰"
          value="{{diagnosis}}"
          bindinput="onDiagnosisInput"
          maxlength="500"
        ></textarea>
      </view>

      <!-- æ¥è½¦ç…§ç‰‡ -->
      <view class="form-item">
        <text class="label required">æ¥è½¦ç…§ç‰‡</text>
        <view class="photo-hint">
          <text class="hint-icon">ğŸ’¡</text>
          <text class="hint-text">è¯·æ‹æ‘„æ•…éšœä½ç½®æˆ–æ›´æ¢é›¶ä»¶ä½ç½®ä½œä¸ºå‡­è¯</text>
        </view>
        <view class="image-upload">
          <block wx:if="{{checkinPhotos.length > 0}}">
            <view class="image-item" wx:for="{{checkinPhotos}}" wx:key="index" wx:for-item="photoItem">
              <image
                class="uploaded-image"
                src="{{photoItem}}"
                mode="aspectFill"
                bindtap="previewImage"
                data-url="{{photoItem}}"
                data-urls="{{checkinPhotos}}"
              />
              <view class="image-delete" bindtap="deleteCheckinPhoto" data-index="{{index}}">
                <text>âœ•</text>
              </view>
            </view>
          </block>
          <view class="upload-btn" wx:if="{{checkinPhotos.length < 9}}" bindtap="chooseCheckinPhoto">
            <text class="upload-icon">ğŸ“·</text>
            <text class="upload-text">æ·»åŠ æ¥è½¦ç…§ç‰‡</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç»´ä¿®å•†å“æ¸…å•ï¼ˆå•†å“é€‰æ‹©æ¨¡å¼ï¼‰ -->
    <view class="form-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ“¦</text>
        <text>ç»´ä¿®å•†å“æ¸…å•</text>
      </view>

      <!-- å·²é€‰å•†å“åˆ—è¡¨ -->
      <view class="selected-products" wx:if="{{selectedItems.length > 0}}">
        <view class="product-item" wx:for="{{selectedItems}}" wx:key="index">
          <view class="product-info">
            <view class="product-name">{{item.name}}</view>
            <view class="product-meta">
              <text class="product-category category-{{item.category}}">{{item.categoryText}}</text>
              <text class="product-divider">|</text>
              <text class="product-price">Â¥{{item.price}}</text>
              <text class="product-divider">|</text>
              <text class="product-unit">{{item.unit}}</text>
            </view>
          </view>
          <view class="product-actions">
            <view class="quantity-control">
              <button class="quantity-btn minus" bindtap="onQuantityInput" data-index="{{index}}" data-value="{{item.quantity - 1}}">-</button>
              <input
                class="quantity-input"
                type="number"
                value="{{item.quantity}}"
                bindinput="onQuantityInput"
                data-index="{{index}}"
              />
              <button class="quantity-btn plus" bindtap="onQuantityInput" data-index="{{index}}" data-value="{{item.quantity + 1}}">+</button>
            </view>
            <view class="item-subtotal">Â¥{{utils.toFixed(item.price * item.quantity)}}</view>
            <view class="item-delete" bindtap="deleteItem" data-index="{{index}}">
              <text class="delete-icon">ğŸ—‘ï¸</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€æç¤º -->
      <view class="empty-products" wx:if="{{selectedItems.length === 0}}">
        <text class="empty-icon">ğŸ“¦</text>
        <text class="empty-text">è¿˜æœªæ·»åŠ ä»»ä½•å•†å“</text>
        <text class="empty-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä»å•†å“åº“ä¸­é€‰æ‹©</text>
      </view>

      <!-- æ·»åŠ å•†å“æŒ‰é’® -->
      <button class="add-product-btn" bindtap="addProduct">
        <text class="add-icon">â•</text>
        <text>æ·»åŠ äº§å“æˆ–é¡¹ç›®</text>
      </button>

      <!-- æ€»è®¡åŒºåŸŸ -->
      <view class="total-section">
        <view class="total-row">
          <text class="total-label">æŠ¥ä»·æ€»è®¡</text>
          <text class="total-amount">Â¥{{totalAmount}}</text>
        </view>
      </view>
    </view>

    <!-- æŠ¥ä»·å›¾ç‰‡ -->
    <view class="form-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ“·</text>
        <text>æŠ¥ä»·å›¾ç‰‡ï¼ˆé€‰å¡«ï¼‰</text>
      </view>

      <view class="image-upload">
        <block wx:if="{{quoteImages.length > 0}}">
          <view class="image-item" wx:for="{{quoteImages}}" wx:key="index">
            <image
              class="uploaded-image"
              src="{{item}}"
              mode="aspectFill"
              bindtap="previewImage"
              data-url="{{item}}"
            />
            <view class="image-delete" bindtap="deleteImage" data-index="{{index}}">
              <text>âœ•</text>
            </view>
          </view>
        </block>

        <view class="upload-btn" wx:if="{{quoteImages.length < 9}}" bindtap="chooseImage">
          <text class="upload-icon">ğŸ“·</text>
          <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
        </view>
      </view>
    </view>

    <!-- æŠ¥ä»·è¯´æ˜ -->
    <view class="form-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ’¬</text>
        <text>æŠ¥ä»·è¯´æ˜</text>
      </view>

      <textarea
        class="textarea-field"
        placeholder="è¯·è¾“å…¥æŠ¥ä»·è¯´æ˜ã€ç»´ä¿®æ–¹æ¡ˆã€é¢„è®¡å®Œæˆæ—¶é—´ç­‰ï¼ˆé€‰å¡«ï¼‰"
        value="{{description}}"
        bindinput="onDescriptionInput"
        maxlength="500"
      ></textarea>
    </view>

    <!-- å®¡æ‰¹æµç¨‹æç¤º -->
    <view class="process-hint">
      <view class="hint-title">ğŸ“¢ å®¡æ‰¹æµç¨‹</view>
      <view class="hint-steps">
        <view class="hint-step">
          <view class="step-number">1</view>
          <view class="step-text">æäº¤æŠ¥ä»·</view>
        </view>
        <view class="step-arrow">â†’</view>
        <view class="hint-step">
          <view class="step-number">2</view>
          <view class="step-text">å¹³å°è¿è¥åˆå®¡</view>
        </view>
        <view class="step-arrow">â†’</view>
        <view class="hint-step">
          <view class="step-number">3</view>
          <view class="step-text">è½¦é˜Ÿå®¡æ‰¹</view>
        </view>
        <view class="step-arrow">â†’</view>
        <view class="hint-step">
          <view class="step-number">4</view>
          <view class="step-text">å¼€å§‹ç»´ä¿®</view>
        </view>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <button
      class="submit-btn glass-btn-cta"
      bindtap="handleSubmit"
      disabled="{{submitting}}"
    >
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤æŠ¥ä»·'}}
    </button>
  </block>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-state">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>
