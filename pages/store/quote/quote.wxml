<!--pages/store/quote/quote.wxml - é—¨åº—æŠ€å¸ˆå¡«å†™æŠ¥ä»·-->
<wxs module="utils">
  module.exports = {
    toFixed: function(value) {
      return (value || 0).toFixed(2);
    }
  }
</wxs>
<view class="quote-container">
  <block wx:if="{{order}}">
    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ“‹</text>
        <text>è®¢å•ä¿¡æ¯</text>
      </view>

      <view class="info-row">
        <text class="label">è®¢å•å·</text>
        <text class="value">{{order.orderNumber}}</text>
      </view>

      <view class="info-row">
        <text class="label">è½¦ç‰Œå·</text>
        <text class="value">{{(order.vehicleId && order.vehicleId.plateNumber) || '-'}}</text>
      </view>

      <view class="info-row">
        <text class="label">è½¦é˜Ÿ</text>
        <text class="value">{{(order.vehicleId && order.vehicleId.fleetId && order.vehicleId.fleetId.name) || '-'}}</text>
      </view>

      <view class="info-row">
        <text class="label">æ•…éšœæè¿°</text>
        <text class="value fault-desc">{{order.faultDescription}}</text>
      </view>

      <block wx:if="{{order.faultImages && order.faultImages.length > 0}}">
        <view class="fault-images">
          <image
            wx:for="{{order.faultImages}}"
            wx:key="*this"
            class="fault-image"
            src="{{item}}"
            mode="aspectFill"
            bindtap="previewImage"
            data-url="{{item}}"
            data-urls="{{order.faultImages}}"
          />
        </view>
      </block>
    </view>

    <!-- æŠ¥ä»·é¡¹ç›® -->
    <view class="form-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ’°</text>
        <text>æŠ¥ä»·é¡¹ç›®</text>
      </view>

      <view class="quote-items">
        <view class="quote-item" wx:for="{{quoteItems}}" wx:key="index">
          <view class="item-row">
            <input
              class="item-input item-name"
              placeholder="é¡¹ç›®åç§°ï¼ˆå¦‚ï¼šå·¥æ—¶è´¹ã€ææ–™è´¹ï¼‰"
              value="{{item.name}}"
              bindinput="onItemNameInput"
              data-index="{{index}}"
            />
            <input
              class="item-input item-price"
              type="digit"
              placeholder="å•ä»·"
              value="{{item.price}}"
              bindinput="onItemPriceInput"
              data-index="{{index}}"
            />
            <input
              class="item-input item-quantity"
              type="number"
              placeholder="æ•°é‡"
              value="{{item.quantity}}"
              bindinput="onItemQuantityInput"
              data-index="{{index}}"
            />
            <view class="item-delete" bindtap="deleteQuoteItem" data-index="{{index}}" wx:if="{{quoteItems.length > 1}}">
              <text class="delete-icon">ğŸ—‘ï¸</text>
            </view>
          </view>
          <view class="item-subtotal">
            å°è®¡: Â¥{{utils.toFixed(item.price * item.quantity)}}
          </view>
        </view>
      </view>

      <button class="add-item-btn" bindtap="addQuoteItem">
        <text class="add-icon">â•</text>
        <text>æ·»åŠ é¡¹ç›®</text>
      </button>

      <view class="total-section">
        <text class="total-label">æŠ¥ä»·æ€»è®¡</text>
        <text class="total-amount">Â¥{{totalAmount}}</text>
      </view>
    </view>

    <!-- æŠ¥ä»·å›¾ç‰‡ -->
    <view class="form-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ“·</text>
        <text>æŠ¥ä»·å›¾ç‰‡ï¼ˆé€‰å¡«ï¼‰</text>
      </view>

      <view class="image-upload">
        <block wx:if="{{quoteImages.length > 0}}">
          <view class="image-item" wx:for="{{quoteImages}}" wx:key="index">
            <image
              class="uploaded-image"
              src="{{item}}"
              mode="aspectFill"
              bindtap="previewImage"
              data-url="{{item}}"
            />
            <view class="image-delete" bindtap="deleteImage" data-index="{{index}}">
              <text>âœ•</text>
            </view>
          </view>
        </block>

        <view class="upload-btn" wx:if="{{quoteImages.length < 9}}" bindtap="chooseImage">
          <text class="upload-icon">ğŸ“·</text>
          <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
        </view>
      </view>
    </view>

    <!-- å…¶ä»–ä¿¡æ¯ -->
    <view class="form-section glass-card">
      <view class="section-title">
        <text class="icon">ğŸ“</text>
        <text>å…¶ä»–ä¿¡æ¯</text>
      </view>

      <view class="form-item">
        <text class="label">é¢„è®¡å®Œæˆå¤©æ•°</text>
        <picker
          class="picker"
          mode="selector"
          range="{{[1,2,3,5,7,10,15]}}"
          value="{{estimatedDays - 1}}"
          bindchange="onDaysChange"
        >
          <view class="picker-text">
            {{estimatedDays}} å¤©
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="label">æŠ¥ä»·è¯´æ˜</text>
        <textarea
          class="textarea-field"
          placeholder="è¯·è¾“å…¥æŠ¥ä»·è¯´æ˜ã€ç»´ä¿®æ–¹æ¡ˆç­‰ï¼ˆé€‰å¡«ï¼‰"
          value="{{description}}"
          bindinput="onDescriptionInput"
          maxlength="500"
        ></textarea>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <button
      class="submit-btn glass-btn-cta"
      bindtap="handleSubmit"
      disabled="{{submitting}}"
    >
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤æŠ¥ä»·'}}
    </button>
  </block>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-state">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>
