<!--pages/order-detail/order-detail.wxml - è®¢å•è¯¦æƒ…é¡µé¢-->
<view class="page">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è®¢å•è¯¦æƒ… -->
  <view class="order-detail" wx:if="{{!loading && order}}">
    <!-- é¡¶éƒ¨çŠ¶æ€å¡ç‰‡ -->
    <view class="status-card status-{{order.status}}">
      <view class="status-icon">{{order.statusIcon}}</view>
      <view class="status-info">
        <view class="status-text">{{order.statusText}}</view>
        <view class="status-hint">{{order.statusHint}}</view>
      </view>
    </view>

    <!-- è¿›åº¦æ—¶é—´çº¿ -->
    <view class="timeline" wx:if="{{order.timeline && order.timeline.length > 0}}">
      <view class="timeline-item" wx:for="{{order.timeline}}" wx:key="index">
        <view class="timeline-dot {{item.completed ? 'active' : ''}}"></view>
        <view class="timeline-content">
          <view class="timeline-title">{{item.title}}</view>
          <view class="timeline-time" wx:if="{{item.time}}">{{item.time}}</view>
        </view>
      </view>
    </view>

    <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-card">
      <view class="card-title">è®¢å•ä¿¡æ¯</view>
      <view class="info-row">
        <text class="info-label">è®¢å•ç¼–å·</text>
        <text class="info-value">{{order.orderNumber}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">åˆ›å»ºæ—¶é—´</text>
        <text class="info-value">{{order.createdAtText}}</text>
      </view>
    </view>

    <!-- è½¦è¾†ä¿¡æ¯ -->
    <view class="info-card" bindtap="onVehicleDetail" data-vehicle-id="{{order.vehicleId._id}}">
      <view class="card-title">è½¦è¾†ä¿¡æ¯</view>
      <view class="vehicle-info">
        <view class="vehicle-main">
          <text class="vehicle-plate">{{order.vehicleId.plateNumber}}</text>
          <text class="vehicle-model">{{order.vehicleId.brand}} {{order.vehicleId.model}}</text>
        </view>
        <text class="arrow-icon">â€º</text>
      </view>
    </view>

    <!-- æ•…éšœæè¿° -->
    <view class="info-card">
      <view class="card-title">æ•…éšœæè¿°</view>
      <view class="fault-content">{{order.faultDescription}}</view>
      <!-- æ•…éšœå›¾ç‰‡ -->
      <view class="fault-images" wx:if="{{order.faultImages && order.faultImages.length > 0}}">
        <image
          class="fault-image"
          wx:for="{{order.faultImages}}"
          wx:for-item="image"
          wx:key="*this"
          src="{{image}}"
          mode="aspectFill"
          bindtap="onPreviewImage"
          data-url="{{image}}"
          data-urls="{{order.faultImages}}"
        />
      </view>
    </view>

    <!-- é—¨åº—ä¿¡æ¯ï¼ˆå·²æ¥å•åæ˜¾ç¤ºï¼‰ -->
    <view class="info-card" wx:if="{{order.storeId}}">
      <view class="card-title">ç»´ä¿®é—¨åº—</view>
      <view class="store-info">
        <view class="store-name">{{order.storeId.name}}</view>
        <view class="store-detail">
          <text class="detail-icon">ğŸ“</text>
          <text>{{order.storeId.address}}</text>
        </view>
        <view class="store-detail" wx:if="{{order.storeId.phone}}">
          <text class="detail-icon">ğŸ“</text>
          <text>{{order.storeId.phone}}</text>
        </view>
      </view>
      <button class="contact-btn" bindtap="onContactStore">
        <text class="btn-icon">ğŸ“</text>
        è”ç³»é—¨åº—
      </button>
    </view>

    <!-- ç»´ä¿®æŠ¥ä»·ï¼ˆå·²æŠ¥ä»·åæ˜¾ç¤ºï¼‰ -->
    <view class="info-card" wx:if="{{order.quote}}">
      <view class="card-title">ç»´ä¿®æŠ¥ä»·</view>
      <view class="quote-items">
        <view class="quote-item" wx:for="{{order.quote.items}}" wx:key="name">
          <view class="item-name">{{item.name}}</view>
          <view class="item-price">Â¥{{item.price}} Ã— {{item.quantity}}</view>
        </view>
      </view>
      <view class="quote-total">
        <text class="total-label">æ€»è®¡ï¼š</text>
        <text class="total-value">Â¥{{order.quote.total}}</text>
      </view>
      <!-- æŠ¥ä»·å›¾ç‰‡ -->
      <view class="quote-images" wx:if="{{order.quote.images && order.quote.images.length > 0}}">
        <image
          class="quote-image"
          wx:for="{{order.quote.images}}"
          wx:for-item="image"
          wx:key="*this"
          src="{{image}}"
          mode="aspectFill"
          bindtap="onPreviewImage"
          data-url="{{image}}"
          data-urls="{{order.quote.images}}"
        />
      </view>
    </view>

    <!-- ç»´ä¿®æ—¥å¿— -->
    <view class="info-card" wx:if="{{order.logs && order.logs.length > 0}}">
      <view class="card-title">ç»´ä¿®æ—¥å¿—</view>
      <view class="log-list">
        <view class="log-item" wx:for="{{order.logs}}" wx:key="_id">
          <view class="log-header">
            <text class="log-operator">{{item.operatorId.nickname}}</text>
            <text class="log-time">{{item.createdAtText}}</text>
          </view>
          <view class="log-content">{{item.content}}</view>
          <!-- æ—¥å¿—å›¾ç‰‡ -->
          <view class="log-images" wx:if="{{item.images && item.images.length > 0}}">
            <image
              class="log-image"
              wx:for="{{item.images}}"
              wx:for-item="image"
              wx:key="*this"
              src="{{image}}"
              mode="aspectFill"
              bindtap="onPreviewImage"
              data-url="{{image}}"
              data-urls="{{item.images}}"
            />
          </view>
        </view>
      </view>
    </view>

    <!-- å®Œå·¥ä¿¡æ¯ï¼ˆå·²å®Œå·¥åæ˜¾ç¤ºï¼‰ -->
    <view class="info-card" wx:if="{{order.completion}}">
      <view class="card-title">å®Œå·¥ä¿¡æ¯</view>
      <view class="completion-content">{{order.completion.description}}</view>
      <!-- å®Œå·¥å›¾ç‰‡ -->
      <view class="completion-images" wx:if="{{order.completion.images && order.completion.images.length > 0}}">
        <image
          class="completion-image"
          wx:for="{{order.completion.images}}"
          wx:for-item="image"
          wx:key="*this"
          src="{{image}}"
          mode="aspectFill"
          bindtap="onPreviewImage"
          data-url="{{image}}"
          data-urls="{{order.completion.images}}"
        />
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="action-bar">
      <!-- è½¦é˜Ÿç®¡ç†å‘˜å®¡æ‰¹æŒ‰é’® -->
      <button
        class="action-btn approve"
        wx:if="{{order.status === 'quoted' && userRole === 'FLEET_MANAGER'}}"
        bindtap="onApproveQuote"
        data-approved="{{true}}"
      >
        <text class="btn-icon">âœ“</text>
        æ‰¹å‡†æŠ¥ä»·
      </button>
      <button
        class="action-btn reject"
        wx:if="{{order.status === 'quoted' && userRole === 'FLEET_MANAGER'}}"
        bindtap="onApproveQuote"
        data-approved="{{false}}"
      >
        <text class="btn-icon">âœ•</text>
        æ‹’ç»æŠ¥ä»·
      </button>

      <!-- é—¨åº—æŠ€å¸ˆæ“ä½œæŒ‰é’® -->
      <button
        class="action-btn primary"
        wx:if="{{order.status === 'pending' && userRole === 'STORE_TECHNICIAN'}}"
        bindtap="onReceiveOrder"
      >
        <text class="btn-icon">ğŸ“‹</text>
        æ¥å•
      </button>
      <button
        class="action-btn primary"
        wx:if="{{order.status === 'received' && userRole === 'STORE_TECHNICIAN'}}"
        bindtap="onSubmitQuote"
      >
        <text class="btn-icon">ğŸ’°</text>
        æäº¤æŠ¥ä»·
      </button>
      <button
        class="action-btn primary"
        wx:if="{{order.status === 'approved' && userRole === 'STORE_TECHNICIAN'}}"
        bindtap="onCompleteOrder"
      >
        <text class="btn-icon">âœ“</text>
        æäº¤å®Œå·¥
      </button>

      <!-- å®¢æˆ·ç¡®è®¤æŒ‰é’® -->
      <button
        class="action-btn confirm"
        wx:if="{{order.status === 'completed' && userRole === 'DRIVER'}}"
        bindtap="onConfirmOrder"
      >
        <text class="btn-icon">âœ“</text>
        ç¡®è®¤å®Œå·¥
      </button>
    </view>
  </view>
</view>
