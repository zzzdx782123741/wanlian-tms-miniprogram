<!--pages/orders/orders.wxml - è®¢å•åˆ—è¡¨é¡µé¢ - ç°ä»£åŒ–è®¾è®¡-->
<view class="page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="header">
    <view class="header-title">è®¢å•ä¸­å¿ƒ</view>
    <view class="header-subtitle">ç®¡ç†å’Œè¿½è¸ªæ‚¨çš„è®¢å•</view>
  </view>

  <!-- çŠ¶æ€ç­›é€‰æ ‡ç­¾ -->
  <view class="filter-tabs">
    <view
      class="tab-item {{activeTab === 'all' ? 'active' : ''}}"
      data-tab="all"
      bindtap="onTabChange"
    >
      <text class="tab-text">å…¨éƒ¨</text>
      <text class="tab-badge" wx:if="{{counts.all > 0}}">{{counts.all}}</text>
    </view>
    <view
      class="tab-item {{activeTab === 'pending' ? 'active' : ''}}"
      data-tab="pending"
      bindtap="onTabChange"
    >
      <text class="tab-text">å¾…å¤„ç†</text>
      <text class="tab-badge" wx:if="{{counts.pending > 0}}">{{counts.pending}}</text>
    </view>
    <view
      class="tab-item {{activeTab === 'processing' ? 'active' : ''}}"
      data-tab="processing"
      bindtap="onTabChange"
    >
      <text class="tab-text">è¿›è¡Œä¸­</text>
      <text class="tab-badge" wx:if="{{counts.processing > 0}}">{{counts.processing}}</text>
    </view>
    <view
      class="tab-item {{activeTab === 'completed' ? 'active' : ''}}"
      data-tab="completed"
      bindtap="onTabChange"
    >
      <text class="tab-text">å·²å®Œæˆ</text>
      <text class="tab-badge" wx:if="{{counts.completed > 0}}">{{counts.completed}}</text>
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && orders.length === 0}}">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-text">æš‚æ— è®¢å•</text>
      <text class="empty-hint">å¿«å»åˆ›å»ºç¬¬ä¸€ä¸ªç»´ä¿®è®¢å•å§</text>
    </view>

    <!-- è®¢å•å¡ç‰‡ -->
    <view
      class="order-card"
      wx:for="{{orders}}"
      wx:key="_id"
      bindtap="onOrderTap"
      data-id="{{item._id}}"
    >
      <!-- è®¢å•ç±»å‹æ ‡ç­¾ -->
      <view class="order-type-badge type-{{item.type}}">
        {{item.type === 'maintenance' ? 'ä¿å…»' : 'ç»´ä¿®'}}
      </view>

      <!-- è®¢å•çŠ¶æ€æ ‡ç­¾ -->
      <view class="order-status status-{{item.status}}">
        {{item.statusText}}
      </view>

      <!-- è®¢å•å¤´éƒ¨ -->
      <view class="order-header">
        <view class="order-number">è®¢å•å·ï¼š{{item.orderNumber}}</view>
        <view class="order-time">{{item.createdAtText}}</view>
      </view>

      <!-- è½¦è¾†ä¿¡æ¯ -->
      <view class="order-vehicle">
        <text class="vehicle-icon">ğŸšš</text>
        <view class="vehicle-info">
          <view class="vehicle-plate">{{item.vehicleInfo.plateNumber}}</view>
          <view class="vehicle-model">{{item.vehicleInfo.brand}} {{item.vehicleInfo.model}}</view>
        </view>
      </view>

      <!-- ç»´ä¿®è®¢å•ï¼šæ•…éšœæè¿° -->
      <view class="order-fault" wx:if="{{item.type === 'repair' && item.faultDescription}}">
        <text class="fault-label">æ•…éšœæè¿°ï¼š</text>
        <text class="fault-text">{{item.faultDescription}}</text>
      </view>

      <!-- ä¿å…»è®¢å•ï¼šä¿å…»ç±»å‹å’Œå¥—é¤ -->
      <view class="order-maintenance" wx:if="{{item.type === 'maintenance'}}">
        <text class="maint-label">ä¿å…»ç±»å‹ï¼š</text>
        <text class="maint-value">{{item.maintenanceTypeName || '-'}}</text>
      </view>
      <view class="order-maintenance" wx:if="{{item.type === 'maintenance'}}">
        <text class="maint-label">å¥—é¤ï¼š</text>
        <text class="maint-value">{{item.packageName || item.selectedTier || '-'}}</text>
      </view>

      <!-- è¿›åº¦æ¡ï¼ˆè¿›è¡Œä¸­çš„è®¢å•ï¼‰ -->
      <view class="order-progress" wx:if="{{item.showProgress}}">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{item.progress}}%"></view>
        </view>
        <view class="progress-text">{{item.progressText}}</view>
      </view>

      <!-- è®¢å•åº•éƒ¨ä¿¡æ¯ -->
      <view class="order-footer">
        <!-- ç»´ä¿®è®¢å•ï¼šæ˜¾ç¤ºæŠ¥ä»· -->
        <view class="order-price" wx:if="{{item.type === 'repair' && item.quote}}">
          <text class="price-label">æŠ¥ä»·ï¼š</text>
          <text class="price-value">Â¥{{item.quote.total}}</text>
        </view>
        <!-- ä¿å…»è®¢å•ï¼šæ˜¾ç¤ºé‡‘é¢ -->
        <view class="order-price" wx:if="{{item.type === 'maintenance'}}">
          <text class="price-label">é‡‘é¢ï¼š</text>
          <text class="price-value">Â¥{{item.finalAmount || '-'}}</text>
        </view>
        <!-- å¾…è½¦é˜Ÿå®¡æ‰¹è®¢å•æ˜¾ç¤ºå»å®¡æ‰¹æŒ‰é’®ï¼ˆä»…è½¦é˜Ÿç®¡ç†å‘˜ã€å¹³å°è¿è¥ï¼‰ -->
        <button
          class="approve-btn"
          wx:if="{{role !== 'DRIVER' && role !== 'STORE_TECHNICIAN' && item.status === 'awaiting_fleet_approval'}}"
          catchtap="onApproveOrder"
          data-id="{{item._id}}"
        >
          å»å®¡æ‰¹
        </button>
        <!-- å¾…æŠ¥ä»·å®¡æ‰¹è®¢å•æ˜¾ç¤ºå»å®¡æ‰¹æŒ‰é’®ï¼ˆä»…è½¦é˜Ÿç®¡ç†å‘˜ã€å¹³å°è¿è¥ï¼‰ -->
        <button
          class="approve-btn"
          wx:if="{{role !== 'DRIVER' && role !== 'STORE_TECHNICIAN' && item.status === 'awaiting_approval'}}"
          catchtap="onApproveOrder"
          data-id="{{item._id}}"
        >
          å»å®¡æ‰¹
        </button>
        <!-- å¾…ç¡®è®¤è®¢å•æ˜¾ç¤ºå»ç¡®è®¤æŒ‰é’®ï¼ˆä»…å¸æœºï¼‰ -->
        <button
          class="confirm-btn"
          wx:if="{{role === 'DRIVER' && item.status === 'completed' && !item.isConfirmed}}"
          catchtap="onConfirmOrder"
          data-id="{{item._id}}"
        >
          å»ç¡®è®¤
        </button>
        <!-- å¯è¯„ä»·è®¢å•æ˜¾ç¤ºå»è¯„ä»·æŒ‰é’®ï¼ˆä»…å¸æœºï¼Œ15å¤©å†…ï¼‰ -->
        <button
          class="review-btn"
          wx:if="{{role === 'DRIVER' && item.canReview}}"
          catchtap="onReviewOrder"
          data-id="{{item._id}}"
        >
          å»è¯„ä»·
        </button>
        <!-- å…¶ä»–çŠ¶æ€æ˜¾ç¤ºç®­å¤´ -->
        <view class="order-arrow" wx:if="
          {{!(role !== 'DRIVER' && role !== 'STORE_TECHNICIAN' && (item.status === 'awaiting_fleet_approval' || item.status === 'awaiting_approval'))}} &&
          {{!(role === 'DRIVER' && item.status === 'completed' && !item.isConfirmed)}} &&
          {{!(role === 'DRIVER' && item.canReview)}}
        ">â€º</view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-more" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>
